var MongoClient = require('mongodb').MongoClient
  , format = require('util').format;

//MongoClient.connect('mongodb://127.0.0.1:27017/test', function(err, db) {
//  if(err) throw err;
//
//  var collection = db.collection('test_insert');
//  collection.insert({a:2}, function(err, docs) {
//
//    collection.count(function(err, count) {
//      console.log(format("count = %s", count));
//    });
//
//    // Locate all the entries using find
//    collection.find().toArray(function(err, results) {
//      console.dir(results);
//      // Let's close the db
//      db.close();
//    });
//  });
//})


var build_query = function(query){

  MongoClient.connect('mongodb://127.0.0.1:27017/test', function(err, db) {
    if(err) throw err;

    var collection = db.collection('test_insert');

    query(collection, function(err, value) {
      db.close();
    });
  });
};

var logcallback = function (err, obj){
  obj = err || obj;
  console.log(obj);
}

var insertItem = function (obj, callback) {
  return build_query(function(collection){
    return collection.insert(obj, callback);
  });
};

var countItems = function (callback) {
  return build_query(function(collection){
    return collection.count(callback);
  });
};

var findOne = function (obj, callback) {
  return build_query(function(collection){
    return collection.findOne(obj, callback);
  });
};

var findUser = function (username, callback) {
  return findOne({username: username}, callback)
}

countItems(logcallback);
insertItem({username: 'joe'}, logcallback);
findUser('francis', logcallback);

logcallback(null, '45')
