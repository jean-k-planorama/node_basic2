
// Dependencies

var MongoClient = require('mongodb').MongoClient;
var async = require('async');


/**
 * MongoHandler
 *
 * @info Handles a MongoDB instance
 *
 * @param dbName
 * @param dbPath
 * @returns {{}}
 * @constructor
 */
var MongoHandler = function(dbName, dbPath){

  var handler = {}

  handler.dbName = dbName || 'test';
  handler.dbPath = dbPath || ('mongodb://127.0.0.1:27017/' + dbName);

  /**
   * open: open a connection to the database
   * @param callback
   * @returns {null}
   */
  handler.open = function open(callback){
    return MongoClient.connect(handler.dbPath, function(err, db){
      if(err) throw err;
      if(!db) throw new Error('Could not access database: ', handler.dbPath);
      handler.db = db;
      console.log('Connected to database: ', handler.dbPath);
      return callback(null, handler);
    });
  };

  /**
   * collection
   *
   * @info returns a collection with the corresponding name
   *
   * @param collectionName
   * @returns {*|null}
   */
  handler.collection = function collection(collectionName){
    if(!handler.db) throw new Error('Database has to be opened first');
    return handler.db.collection(collectionName)
  };

  /**
   * initCollec
   *
   * @info (re)initiates the content of a collection and its index
   *
   * @param collectionName
   * @param indexInit
   * @param callback
   */
  handler.initCollec = function (collectionName, indexInit, callback) {

    var collection = handler.collection(collectionName || 'test');

    async.series([
        function remove_data(cb) {
          return collection.remove(cb);
        },
        function removeIndex(cb) {
          return collection.dropAllIndexes(cb);
        },
        function setIndex(cb) {
          return indexInit(collection, callback);
          return collection.ensureIndex({ "username": 1 }, { unique: true }, cb);
        }
      ],
      callback
    );
  };

  return handler;
}


module.exports = MongoHandler