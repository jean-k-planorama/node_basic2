var MongoClient = require('mongodb').MongoClient
  , format = require('util').format;


/**
 *
 * @param collectionName
 * @param dbName
 * @returns {{}}
 * @constructor
 */
var MongoHandler = function(collectionName, dbName){

  var handler = {}

  dbName = 'mongodb://127.0.0.1:27017/' + (dbName || 'test');
  collectionName = collectionName || 'mongodb://127.0.0.1:27017/test';

  handler.getDbName = function(){
    return dbName;
  }
  handler.collectionName = function(){
    return collectionName;
  }

  queryBuilder = function(query){
    MongoClient.connect(dbName, function(err, db) {
      if(err) throw err;

      var collection = db.collection(collectionName);

      query(collection, function(err, value) {
        db.close();
      });
    });
  };

  handler.insert= function (obj, callback) {
    return queryBuilder(function(collection){
      return collection.insert(obj, callback);
    });
  };

  handler.count = function (query, callback) {
    return queryBuilder(function(collection){
      return collection.count(query, callback);
    });
  };

  handler.save = function(obj, callback) {
    return queryBuilder(function(collection){
      return collection.save(obj, callback);
    });
  };

  handler.findOne = function (obj, callback) {
    return queryBuilder(function(collection){
      return collection.findOne(obj, callback);
    });
  };

  handler.remove = function (query, callback) {
    return queryBuilder(function(collection){
      return collection.remove(query, callback);
    });
  };

  handler.initCollec = function (index_init, callback) {
    return queryBuilder(function(collection){
      function remove_data() {
        return collection.remove(remove_index);
      };
      function remove_index() {
        return collection.dropAllIndexes(set_index);
      };
      function set_index() {
        return index_init(collection, callback);
        return collection.ensureIndex({ "username": 1 }, { unique: true }, callback);
      };
      return remove_data();
    });
  };

  return handler;
}


module.exports = MongoHandler